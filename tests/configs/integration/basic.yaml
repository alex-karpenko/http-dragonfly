# Requires echo server on port 3000

# failed_then_ok
# failed_then_target_id
# failed_then_override
# ok_then_failed
# ok_then_target_id
# ok_then_override
# always_target_id
# always_override
# conditional_routing

listeners:
  # Basic forwarding
  - id: basic-forwarding-8000
    listen_on: "*:8000"
    strategy: failed_then_ok
    targets:
    - url: http://localhost:3000/${CTX_REQUEST_HEADERS_X_DELAY}
      timeout: 1s
      body: "GOOD"
      headers:
        - drop: content-length
        - add: X-Path
          value: ${CTX_REQUEST_PATH}

  # Failed first, ok
  - id: invalid-target-8001
    listen_on: "*:8001"
    strategy: failed_then_ok
    targets:
    - id: "GOOD"
      url: http://localhost:3000/
      body: GOOD
    - id: "WRONG"
      url: http://localhost:65535/
      body: WRONG
      condition: .request.headers["x-skip-wrong"] != "yes"
    - id: "TIMEOUT"
      timeout: 1s
      url: http://localhost:3000/2
      body: TIMEOUT
      condition: .request.headers["x-include-timeout"] == "yes"
    response:
      override:
        headers:
        - add: x-target-id
          value: ${CTX_TARGET_ID}

  # Failed first, target id
  - id: invalid-target-8002
    listen_on: "*:8002"
    strategy: failed_then_target_id
    targets:
    - id: "GOOD"
      url: http://localhost:3000/
      body: GOOD
    - id: "WRONG"
      url: http://localhost:65535/
      body: WRONG
      condition: .request.headers["x-skip-wrong"] != "yes"
    - id: "TIMEOUT"
      timeout: 1s
      url: http://localhost:3000/2
      body: TIMEOUT
      condition: .request.headers["x-include-timeout"] == "yes"
    response:
      target_selector: GOOD
      override:
        headers:
        - add: x-target-id
          value: ${CTX_TARGET_ID}

  # Failed first, override
  - id: invalid-target-8003
    listen_on: "*:8003"
    strategy: failed_then_override
    headers:
      - drop: content-length
    targets:
    - id: "GOOD"
      url: http://localhost:3000/
      body: GOOD
    - id: "WRONG"
      url: http://localhost:65535/
      body: WRONG
      condition: .request.headers["x-skip-wrong"] != "yes"
    - id: "TIMEOUT"
      timeout: 1s
      url: http://localhost:3000/2
      body: TIMEOUT
      condition: .request.headers["x-include-timeout"] == "yes"
    response:
      override:
        headers:
        - add: x-target-id
          value: ${CTX_TARGET_ID}
